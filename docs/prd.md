# 产品需求文档 (PRD): Containerized Remote WeChat

| 文档版本 | V1.1 |
| :--- | :--- |
| **项目名称** | Containerized Remote WeChat (CRW) |
| **状态** | **开发中 (In Progress)** |
| **核心目标** | 在远程服务器容器中运行微信，在本地通过 Web 协议实现“原生应用级”的无缝体验。 |

---

## 1. 背景与痛点

* **需求背景**：用户需要将微信后端逻辑与数据驻留在远程服务器（Linux），实现环境隔离、网络策略控制或数据安全。
* **当前痛点**：
  * **X11 Forwarding/传统 VNC**：延迟极高，无法通过广域网使用。
  * **输入法断层**：本地输入法无法直接控制远程 GUI，导致中文输入体验极差。
  * **视觉干扰**：远程桌面方案（如 XFCE）包含多余的任务栏和背景，缺乏沉浸感。
  * **依赖地狱**：新版 Electron 微信在精简 Linux 容器中缺乏大量底层库（GTK, XCB, t64 等）。

## 2. 核心技术架构

本方案采用 **B/S 架构** 模拟 **C/S 体验**。

* **基础设施 (Container)**: Docker
* **基础镜像**: `linuxserver/webtop:ubuntu-openbox` (Ubuntu 24.04 Base)
* **显示协议**: KasmVNC (支持 HTTP/Websocket 流式传输，音频穿透)
* **窗口管理**: Openbox (配置为 Kiosk 模式，无边框强制全屏)
* **客户端呈现**: Chrome App Mode (`--app` 参数)

## 3. 功能需求 (Functional Requirements)

### 3.1 容器化运行环境

| ID | 需求名称 | 详细描述 | 优先级 | 开发状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F-01** | **依赖自愈** | 镜像构建时必须包含 Electron 及 Qt/XCB 所需的所有动态链接库（适配 Ubuntu 24.04 t64 架构），杜绝 `Loading shared libraries error`。 | P0 | **已完成** |
| **F-02** | **无沙箱运行** | 启动脚本必须强制通过 `--no-sandbox` 参数运行微信，以适配 Docker 的 Root 权限限制。 | P0 | **待修复** (autostart 未添加参数) |
| **F-03** | **中文字体支持** | 内置 `fonts-noto-cjk` 及 `wqy` 系列字体，确保界面无乱码。 | P0 | **已完成** |

### 3.2 窗口与显示管理

| ID | 需求名称 | 详细描述 | 优先级 | 开发状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F-04** | **Kiosk 模式** | Openbox 必须配置为去除所有窗口装饰（标题栏、最大化按钮），实现沉浸式显示。 | P0 | **已完成** |
| **F-05** | **智能全屏** | 针对微信主窗口实施 `<maximized>yes</maximized>` 规则；针对登录弹窗允许居中显示（接受登录态的黑边留白）。 | P1 | **已完成** |
| **F-06** | **分辨率自适应** | 容器分辨率应跟随客户端浏览器窗口大小动态调整 (KasmVNC Auto-resize)。 | P1 | **已完成** (WebTop 自带) |

### 3.3 输入与交互

| ID | 需求名称 | 详细描述 | 优先级 | 开发状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F-07** | **远程输入法** | 容器内必须运行 Fcitx 守护进程，并在 `autostart` 中正确配置环境变量 (`GTK_IM_MODULE` 等)。 | P0 | **已完成** |
| **F-08** | **剪贴板注入** | 支持通过 Kasm 侧边栏工具将本地长文本无损注入到远程输入框，解决高延迟打字问题。 | P1 | **已完成** (WebTop 自带) |

### 3.4 数据持久化

| ID | 需求名称 | 详细描述 | 优先级 | 开发状态 |
| :--- | :--- | :--- | :--- | :--- |
| **F-09** | **状态保存** | 必须通过 Volume 挂载 `/root/.xwechat` 和 `/root/xwechat_files`，确保容器重启后不需要重新扫码，聊天记录不丢失。 | P0 | **部分完成** (缺失 `xwechat_files` 挂载) |

## 4. 非功能需求 (Non-functional Requirements)

* **N-01 启动速度**：容器启动到微信二维码出现的冷启动时间应 < 5秒。 (**待测试**)
* **N-02 稳定性**：需配置 `shm_size: 4gb` 或更高，防止 Electron 因共享内存不足崩溃。 (**已完成**)
* **N-03 兼容性**：客户端仅需支持 Chrome/Edge 浏览器的桌面操作系统（Win/Mac/Linux）。 (**设计固有**)

## 5. 交付物清单 (Deliverables)

| 交付物 | 状态 | 说明 |
| :--- | :--- | :--- |
| **`Dockerfile`** | ✅ 已创建 | 包含完整依赖安装链 |
| **`docker-compose.yml`** | ✅ 已创建 | 包含 Volumes 和 Shm 配置 |
| **`inject_openbox_rules.sh`** | ✅ 已创建 | 动态修改 `rc.xml` |
| **`autostart`** | ✅ 已创建 | Fcitx 与 WeChat 启动编排 |
| **`client_launch_script`** | ❌ 未创建 | 本地一键启动脚本 |

## 6. 已知局限性 (Known Limitations)

* **登录页黑边**：由于微信登录窗口强制固定大小，且 Web 画布必须矩形填充，扫码阶段会有黑色背景填充，此为物理限制，不可消除。
* **音频延迟**：虽然支持音频穿透，但网络环境可能导致消息提示音有 0.5s - 1s 的延迟。

---

**下一步**：

1. 修正 `autostart` 脚本，添加 `--no-sandbox` 参数 (F-02)。
2. 修正 `docker-compose.yml`，补全 `xwechat_files` 挂载 (F-09)。
3. 创建本地启动脚本 `client_launch_script`。
4. 启动容器进行集成测试。
